generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MatchStatus {
  SCHEDULED
  FINISHED
}

enum SelectionLabel {
  H
  D
  A
}

model Team {
  id             String  @id @default(cuid())
  name           String
  normalizedName String  @unique
  homeMatches    Match[] @relation("HomeTeam")
  awayMatches    Match[] @relation("AwayTeam")
}

model Match {
  id          String      @id
  kickoff     DateTime
  season      String
  status      MatchStatus @default(SCHEDULED)
  homeTeamId  String
  awayTeamId  String
  homeGoals   Int?
  awayGoals   Int?
  resultLabel SelectionLabel?
  homeTeam    Team        @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam    Team        @relation("AwayTeam", fields: [awayTeamId], references: [id])
  odds        OddsSnapshot[]
  predictions PredictionCache[]
  picks       Pick[]

  @@index([kickoff])
}

model OddsSnapshot {
  id         String   @id @default(cuid())
  matchId    String
  capturedAt DateTime @default(now())
  homeOdds   Float?
  drawOdds   Float?
  awayOdds   Float?
  source     String
  match      Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId, capturedAt])
}

model PredictionCache {
  id                String   @id @default(cuid())
  matchId           String
  createdAt         DateTime @default(now())
  probsH            Float
  probsD            Float
  probsA            Float
  lambdaHome        Float
  lambdaAway        Float
  topScorelinesJson Json
  modelVersion      String
  match             Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId, createdAt])
}

model Pick {
  id             String         @id @default(cuid())
  createdAt      DateTime       @default(now())
  sessionKey     String
  matchId        String
  selectionLabel SelectionLabel
  oddsAtPick     Float
  stake          Float          @default(1)
  probsAtPickJson Json
  ev             Float
  edge           Float
  settledAt      DateTime?
  settledResult  SelectionLabel?
  profit         Float?
  match          Match          @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([sessionKey, createdAt])
}

model RefreshRun {
  id         String   @id @default(cuid())
  startedAt  DateTime @default(now())
  finishedAt DateTime?
  ok         Boolean?
  notes      String?
}
