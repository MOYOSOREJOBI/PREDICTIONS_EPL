generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum MatchStatus {
  SCHEDULED
  FINISHED
}

enum SelectionLabel {
  H
  D
  A
}

model Team {
  id             String  @id @default(cuid())
  name           String
  normalizedName String  @unique
  homeMatches    Match[] @relation("HomeTeam")
  awayMatches    Match[] @relation("AwayTeam")
}

model Match {
  id          String      @id @default(cuid())
  date        DateTime
  season      String
  homeTeamId  String
  awayTeamId  String
  homeGoals   Int?
  awayGoals   Int?
  status      MatchStatus @default(SCHEDULED)
  resultLabel SelectionLabel?
  homeTeam    Team        @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam    Team        @relation("AwayTeam", fields: [awayTeamId], references: [id])
  odds        OddsSnapshot[]
  predictions Prediction[]
  picks       Pick[]

  @@index([date])
}

model OddsSnapshot {
  id        String   @id @default(cuid())
  matchId   String
  capturedAt DateTime @default(now())
  homeOdds  Float
  drawOdds  Float
  awayOdds  Float
  source    String
  match     Match    @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([matchId, capturedAt])
}

model Prediction {
  id           String   @id @default(cuid())
  createdAt    DateTime @default(now())
  matchId      String?
  probsH       Float
  probsD       Float
  probsA       Float
  predictedLabel String
  modelVersion String
  featuresJson Json?
  match        Match?   @relation(fields: [matchId], references: [id], onDelete: SetNull)

  @@index([matchId])
}

model UserSession {
  id         String   @id @default(cuid())
  createdAt  DateTime @default(now())
  sessionKey String   @unique
  picks      Pick[]
}

model Pick {
  id             String         @id @default(cuid())
  createdAt      DateTime       @default(now())
  sessionId      String
  matchId        String
  selectionLabel SelectionLabel
  oddsAtPick     Float
  stake          Float?
  predictedProbs Json
  edge           Float
  ev             Float
  settledResult  SelectionLabel?
  profit         Float?
  session        UserSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  match          Match          @relation(fields: [matchId], references: [id], onDelete: Cascade)

  @@index([sessionId, createdAt])
}
